# Advanced Examples

This document provides practical, real-world examples of using Currency.js in common financial scenarios.

## Processing Payments

Create a payment processor that calculates installments and applies discounts:

```javascript
function processPayment(totalAmount, numberOfInstallments, discount = 0) {
  // Apply discount if available
  let finalAmount = Money(totalAmount);

  if (discount > 0) {
    finalAmount = finalAmount.applyDiscount(discount);
    console.log(`Discount applied: ${finalAmount.format()}`);
  }

  // Calculate installments
  const installments = finalAmount.allocate(numberOfInstallments);

  console.log(`Total amount: ${finalAmount.format()}`);
  console.log(`Payment in ${numberOfInstallments} installments:`);

  installments.forEach((installment, index) => {
    console.log(`Installment ${index + 1}: ${installment.format()}`);
  });

  return {
    totalAmount: finalAmount,
    installments,
  };
}

// Usage
const result = processPayment(1299.99, 5, 10);
```

## Shopping Cart Implementation

Create a complete shopping cart with subtotals, discounts, and summaries:

```javascript
class ShoppingCart {
  items = [];

  addItem(name, price, quantity = 1) {
    this.items.push({
      name: name,
      price: price,
      quantity: quantity,
    });
  }

  removeItem(index) {
    if (index >= 0 && index < this.items.length) {
      this.items.splice(index, 1);
    }
  }

  calculateSubtotals() {
    return this.items.map((item) => ({
      ...item,
      subtotal: Calculator.calculateSubtotal(item),
    }));
  }

  calculateTotal() {
    return Calculator.calculateTotal(this.items);
  }

  applyCoupon(discountPercentage) {
    return this.calculateTotal().applyDiscount(discountPercentage);
  }

  summary() {
    const itemsWithSubtotal = this.calculateSubtotals();
    const total = this.calculateTotal();

    console.log('=== CART SUMMARY ===');

    itemsWithSubtotal.forEach((item) => {
      console.log(
        `${item.name} (${item.quantity}x) - ${item.subtotal.format()}`,
      );
    });

    console.log('-----------------------');
    console.log(`TOTAL: ${total.format()}`);

    return {
      items: itemsWithSubtotal,
      total,
    };
  }
}

// Usage
const cart = new ShoppingCart();
cart.addItem('Laptop', 4599.9, 1);
cart.addItem('Mouse', 89.9, 2);
cart.addItem('Keyboard', 199.9, 1);

const summary = cart.summary();
const totalWithDiscount = cart.applyCoupon(15);
console.log(`TOTAL WITH DISCOUNT (15%): ${totalWithDiscount.format()}`);
```

## Tax Calculation

Create a tax calculator for business applications:

```javascript
class TaxCalculator {
  static calculateSalesTax(productValue, icmsRate = 18, issRate = 5) {
    const value = Money(productValue);

    const icms = value.percentage(icmsRate);
    const iss = value.percentage(issRate);
    const totalTaxes = icms.plus(iss);
    const valueWithTaxes = value.plus(totalTaxes);

    return {
      productValue: value,
      icms,
      iss,
      totalTaxes,
      valueWithTaxes
    };
  }

  static generateTaxSummary(product) {
    const result = this.calculateSalesTax(product.price);

    console.log(`=== TAX SUMMARY: ${product.name} ===`);
    console.log(`Product value: ${result.productValue.format()}`);
    console.log(`ICMS (18%): ${result.icms.format()}`);
    console.log(`ISS (5%): ${result.iss.format()}`);
    console.log(`Total taxes: ${result.totalTaxes.format()}`);
    console.log(`Value with taxes: ${result.valueWithTaxes.format()}`);

    return result;
  }
}

// Usage
const product = { name: 'Smartphone', price: 1299.99 };
const taxSummary = TaxCalculator.generateTaxSummary(product);
```

## Subscription Billing

Implement a subscription billing system with prorated fees:

```javascript
class SubscriptionBilling {
  static calculateProration(monthlyFee, daysUsed, daysInMonth = 30) {
    const dailyRate = monthlyFee.dividedBy(daysInMonth);
    return dailyRate.times(daysUsed);
  }

  static generateInvoice(subscription, currentMonth) {
    const { plan, startDate, addons } = subscription;
    const baseFee = Money(plan.monthlyFee);

    // Calculate add-on fees
    const addonFees = addons.reduce((total, addon) => {
      return total.plus(Money(addon.fee));
    }, Money(0));

    // Calculate any prorations if needed
    let prorationFee = Money(0);
    if (startDate.getMonth() === currentMonth.getMonth()) {
      const daysRemaining = this.calculateDaysRemaining(startDate, currentMonth);
      const daysInMonth = this.getDaysInMonth(currentMonth);
      prorationFee = this.calculateProration(baseFee, daysRemaining, daysInMonth);
    }

    const subtotal = baseFee.plus(addonFees).plus(prorationFee);
    const tax = subtotal.percentage(plan.taxRate || 0);
    const total = subtotal.plus(tax);

    return {
      customerName: subscription.customerName,
      planName: plan.name,
      billingDate: new Date(),
      baseFee,
      addonFees,
      prorationFee,
      subtotal,
      tax,
      total
    };
  }

  static calculateDaysRemaining(startDate, currentMonth) {
    // Implementation to calculate days remaining in the month
    const daysInMonth = this.getDaysInMonth(currentMonth);
    const dayOfMonth = startDate.getDate();
    return daysInMonth - dayOfMonth + 1;
  }

  static getDaysInMonth(date) {
    return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
  }
}

// Usage
const subscription = {
  customerName: 'John Doe',
  plan: {
    name: 'Premium',
    monthlyFee: 49.99,
    taxRate: 7
  },
  startDate: new Date(2025, 4, 15), // May 15, 2025
  addons: [
    { name: 'Extra Storage', fee: 9.99 },
    { name: 'Premium Support', fee: 15.00 }
  ]
};

const invoice = SubscriptionBilling.generateInvoice(
  subscription,
  new Date(2025, 4, 1) // May 1, 2025
);

console.log(`Invoice for ${invoice.customerName}`);
console.log(`Plan: ${invoice.planName}`);
console.log(`Base Fee: ${invoice.baseFee.format()}`);
console.log(`Add-ons: ${invoice.addonFees.format()}`);
console.log(`Proration: ${invoice.prorationFee.format()}`);
console.log(`Subtotal: ${invoice.subtotal.format()}`);
console.log(`Tax: ${invoice.tax.format()}`);
console.log(`Total Due: ${invoice.total.format()}`);
```

## International E-commerce

Handle international pricing with currency conversion:

```javascript
class InternationalPricing {
  constructor(exchangeRates) {
    this.exchangeRates = exchangeRates;
  }

  convert(amount, fromCurrency, toCurrency) {
    // Get exchange rate from base currency to target
    const fromRate = this.exchangeRates[fromCurrency] || 1;
    const toRate = this.exchangeRates[toCurrency] || 1;

    // Convert to USD first (as base currency), then to target
    const valueInUSD = Money(amount).dividedBy(fromRate);
    const valueInTarget = valueInUSD.times(toRate);

    // Configure with the target currency
    return Money(valueInTarget.value, {
      currencyCode: toCurrency,
      locale: this.getLocaleForCurrency(toCurrency),
      showSymbol: true
    });
  }

  getLocaleForCurrency(currencyCode) {
    const currencyLocaleMap = {
      'USD': 'en-US',
      'EUR': 'de-DE',
      'GBP': 'en-GB',
      'JPY': 'ja-JP',
      'CAD': 'en-CA',
      'AUD': 'en-AU',
      'BRL': 'pt-BR',
      // Add more as needed
    };

    return currencyLocaleMap[currencyCode] || 'en-US';
  }

  formatPriceList(products, targetCurrency) {
    return products.map(product => {
      const convertedPrice = this.convert(
        product.price,
        product.currency,
        targetCurrency
      );

      return {
        ...product,
        displayPrice: convertedPrice.format(),
        priceMoney: convertedPrice
      };
    });
  }
}

// Usage
const exchangeRates = {
  'USD': 1.00,   // Base currency
  'EUR': 0.85,
  'GBP': 0.75,
  'CAD': 1.25,
  'AUD': 1.35,
  'BRL': 5.20,
  'JPY': 110.59
};

const products = [
  { id: 1, name: 'Laptop', price: 1200, currency: 'USD' },
  { id: 2, name: 'Smartphone', price: 800, currency: 'EUR' },
  { id: 3, name: 'Headphones', price: 100, currency: 'GBP' }
];

const pricingTool = new InternationalPricing(exchangeRates);
const pricesInBRL = pricingTool.formatPriceList(products, 'BRL');

pricesInBRL.forEach(product => {
  console.log(`${product.name}: ${product.displayPrice}`);
});
```

## Dynamic Pricing Engine

Create a pricing engine that applies various pricing rules:

```javascript
class PricingEngine {
  constructor() {
    this.rules = [];
  }

  addRule(name, condition, action) {
    this.rules.push({
      name,
      condition,
      action
    });
  }

  calculatePrice(basePrice, product, customer) {
    let currentPrice = Money(basePrice);
    const appliedRules = [];

    for (const rule of this.rules) {
      if (rule.condition(product, customer)) {
        const previousPrice = currentPrice;
        currentPrice = rule.action(currentPrice, product, customer);

        appliedRules.push({
          ruleName: rule.name,
          previousPrice,
          newPrice: currentPrice,
          difference: currentPrice.minus(previousPrice)
        });
      }
    }

    return {
      finalPrice: currentPrice,
      appliedRules
    };
  }

  generatePriceBreakdown(basePrice, product, customer) {
    const result = this.calculatePrice(basePrice, product, customer);

    console.log(`=== PRICE BREAKDOWN FOR ${product.name} ===`);
    console.log(`Base price: ${Money(basePrice).format()}`);

    result.appliedRules.forEach(rule => {
      const differenceStr = rule.difference.value >= 0
        ? `+${rule.difference.format()}`
        : rule.difference.format();

      console.log(`Applied "${rule.ruleName}": ${differenceStr}`);
    });

    console.log(`Final price: ${result.finalPrice.format()}`);
    return result;
  }
}

// Usage
const pricingEngine = new PricingEngine();

// Add pricing rules
pricingEngine.addRule(
  "Volume Discount",
  (product, customer) => product.quantity >= 5,
  (price) => price.applyDiscount(10)
);

pricingEngine.addRule(
  "Premium Customer",
  (product, customer) => customer.tier === "premium",
  (price) => price.applyDiscount(5)
);

pricingEngine.addRule(
  "Seasonal Surcharge",
  (product) => product.category === "seasonal",
  (price) => price.applySurcharge(15)
);

// Calculate price for a product
const product = {
  name: "Winter Jacket",
  quantity: 7,
  category: "seasonal"
};

const customer = {
  name: "Alice Smith",
  tier: "premium"
};

pricingEngine.generatePriceBreakdown(199.99, product, customer);
```

## Financial Analysis and Reporting

Create a financial reporting system for business analytics:

```javascript
class FinancialReporting {
  static calculateRevenueMetrics(transactions) {
    // Calculate total revenue
    const totalRevenue = transactions.reduce(
      (sum, transaction) => sum.plus(Money(transaction.amount)),
      Money(0)
    );

    // Group by category
    const categories = {};
    transactions.forEach(transaction => {
      const category = transaction.category;
      if (!categories[category]) {
        categories[category] = Money(0);
      }
      categories[category] = categories[category].plus(Money(transaction.amount));
    });

    // Calculate average transaction value
    const avgTransactionValue = transactions.length > 0
      ? totalRevenue.dividedBy(transactions.length)
      : Money(0);

    // Find highest and lowest transactions
    let highestTransaction = { amount: Money(0) };
    let lowestTransaction = { amount: totalRevenue };

    transactions.forEach(transaction => {
      const amount = Money(transaction.amount);

      if (amount.greaterThan(highestTransaction.amount)) {
        highestTransaction = { ...transaction, amount };
      }

      if (amount.lessThan(lowestTransaction.amount)) {
        lowestTransaction = { ...transaction, amount };
      }
    });

    return {
      totalRevenue,
      categoriesSummary: categories,
      avgTransactionValue,
      highestTransaction,
      lowestTransaction,
      transactionCount: transactions.length
    };
  }

  static generateMonthlyReport(transactions, month, year) {
    // Filter transactions for the specified month
    const monthlyTransactions = transactions.filter(transaction => {
      const date = new Date(transaction.date);
      return date.getMonth() === month && date.getFullYear() === year;
    });

    const metrics = this.calculateRevenueMetrics(monthlyTransactions);

    console.log(`=== FINANCIAL REPORT: ${this.getMonthName(month)} ${year} ===`);
    console.log(`Total Revenue: ${metrics.totalRevenue.format()}`);
    console.log(`Average Transaction: ${metrics.avgTransactionValue.format()}`);
    console.log(`Transaction Count: ${metrics.transactionCount}`);

    console.log("\nRevenue by Category:");
    for (const category in metrics.categoriesSummary) {
      console.log(`- ${category}: ${metrics.categoriesSummary[category].format()}`);
    }

    console.log("\nTransaction Range:");
    console.log(`- Highest: ${metrics.highestTransaction.amount.format()} (${metrics.highestTransaction.description})`);
    console.log(`- Lowest: ${metrics.lowestTransaction.amount.format()} (${metrics.lowestTransaction.description})`);

    return metrics;
  }

  static getMonthName(month) {
    const months = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];
    return months[month];
  }
}

// Usage
const transactions = [
  { date: '2025-05-01', amount: 1299.99, category: 'Electronics', description: 'Laptop sale' },
  { date: '2025-05-03', amount: 499.95, category: 'Electronics', description: 'Smartphone sale' },
  { date: '2025-05-05', amount: 29.99, category: 'Accessories', description: 'Phone case' },
  { date: '2025-05-10', amount: 799.50, category: 'Electronics', description: 'Tablet sale' },
  { date: '2025-05-15', amount: 59.99, category: 'Accessories', description: 'Headphones' },
  { date: '2025-05-20', amount: 1599.99, category: 'Electronics', description: 'Gaming PC' },
  { date: '2025-05-25', amount: 19.99, category: 'Accessories', description: 'USB Cable' }
];

const monthlyReport = FinancialReporting.generateMonthlyReport(transactions, 4, 2025); // May 2025
```

These examples demonstrate how Currency.js can be used to build robust financial operations in various business contexts.